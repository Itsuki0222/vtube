<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>VTube 投稿</title>
</head>
<body>
  <h1>新しい投稿</h1>
  <form id="post-form">
    <textarea id="content" placeholder="いまどうしてる？" required></textarea><br>
    <input type="file" id="image"><br>
    <button type="submit">投稿</button>
  </form>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    // ← いずみちゃんの Supabase URL と anon key を入れてね！
    const supabaseUrl = "https://yvxynwjfngvqwjjsqdma.supabase.co";
    const supabaseKey = "eyJhbGciOi...（省略）";
    const supabase = createClient(supabaseUrl, supabaseKey);

    document.getElementById("post-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const content = document.getElementById("content").value;
      const file = document.getElementById("image").files[0];

      // ログイン中のユーザーを取得
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      if (userError || !user) {
        alert("ログインしていません");
        return;
      }

      // 画像アップロード処理
      let imageUrl = null;
      if (file) {
        const filePath = `${user.id}/${Date.now()}-${file.name}`;
        const { error: uploadError } = await supabase.storage
          .from("images") // ←バケット名は「images」にしてる？
          .upload(filePath, file);

        if (uploadError) {
          alert("画像アップロード失敗: " + uploadError.message);
          return;
        }
        imageUrl = `${supabaseUrl}/storage/v1/object/public/images/${filePath}`;
      }

      // 投稿データを挿入
      const { error: insertError } = await supabase
        .from("posts")
        .insert([
          {
            content: content,
            image_url: imageUrl,
            user_id: user.id // ← これが無いと RLS で弾かれる
          }
        ]);

      if (insertError) {
        alert("投稿失敗: " + insertError.message);
        console.error(insertError);
      } else {
        alert("投稿成功！");
        document.getElementById("post-form").reset();
      }
    });
  </script>
</body>
</html>
