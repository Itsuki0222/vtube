<script>
  const supabase = supabase.createClient(
    "https://yvxynwjfngvqwjjsqdma.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2eHlud2pmbmd2cXdqanNxZG1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MTExMjQsImV4cCI6MjA3MTA4NzEyNH0.RLAfsXbVLT1fTu48_EvMYYD4pxFRQk4Ks3zx8DXruBU"
  );

  let currentUser;

  async function checkUser() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      window.location.href = "login.html";
    } else {
      currentUser = user;
      loadPosts();
    }
  }

  async function loadPosts() {
    const { data: posts, error } = await supabase
      .from("posts")
      .select(`
        content, created_at,
        profiles:user_id (username, avatar_url)
      `)
      .order("created_at", { ascending: false });

    const timeline = document.getElementById("timeline");
    timeline.innerHTML = "";

    posts.forEach(post => {
      const div = document.createElement("div");
      div.className = "post";

      const avatar = post.profiles?.avatar_url || "https://placehold.jp/50x50.png";
      const username = post.profiles?.username || "名無し";

      div.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px;">
          <img src="${avatar}" style="width:40px; height:40px; border-radius:50%;">
          <strong>${username}</strong>
        </div>
        <p>${post.content}</p>
        <small>${new Date(post.created_at).toLocaleString()}</small>
      `;
      timeline.appendChild(div);
    });
  }

  document.getElementById("postButton").addEventListener("click", async () => {
    const content = document.getElementById("postContent").value.trim();
    if (content === "") return;

    const { error } = await supabase.from("posts").insert({
      user_id: currentUser.id,
      content
    });

    if (!error) {
      document.getElementById("postContent").value = "";
      loadPosts();
    }
  });

  document.getElementById("logout").addEventListener("click", async () => {
    await supabase.auth.signOut();
    window.location.href = "login.html";
  });

  checkUser();
</script>
