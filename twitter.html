<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>VTube - „Çø„Ç§„É†„É©„Ç§„É≥</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 20px auto; }
    h1 { text-align: center; }
    form { margin-bottom: 20px; }
    .post { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
    .post img.avatar { width: 30px; height: 30px; border-radius: 50%; vertical-align: middle; margin-right: 5px; }
    .post img.post-img { max-width: 100%; margin-top: 10px; border-radius: 8px; }
    .like-btn, .comment-btn { cursor: pointer; color: blue; margin-right: 10px; }
    .comments { margin-top: 10px; padding-left: 20px; }
    .comment { font-size: 0.9em; border-top: 1px solid #eee; padding: 5px 0; }
  </style>
</head>
<body>
  <h1>üê¶ VTube - „Çø„Ç§„É†„É©„Ç§„É≥</h1>

  <!-- ÊäïÁ®ø„Éï„Ç©„Éº„É† -->
  <form id="postForm">
    <textarea id="content" placeholder="„ÅÑ„Åæ„Å©„ÅÜ„Åó„Å¶„ÇãÔºü" required></textarea><br>
    <input type="file" id="image" accept="image/*"><br>
    <button type="submit">ÊäïÁ®ø</button>
  </form>

  <div id="posts">Ë™≠„ÅøËæº„Åø‰∏≠...</div>

  <script>
    const supabase = window.supabase.createClient(
      "https://yvxynwjfngvqwjjsqdma.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2eHlud2pmbmd2cXdqanNxZG1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MTExMjQsImV4cCI6MjA3MTA4NzEyNH0.RLAfsXbVLT1fTu48_EvMYYD4pxFRQk4Ks3zx8DXruBU"
    );

    let currentUser = null;

    // üîë „É≠„Ç∞„Ç§„É≥Á¢∫Ë™ç
    async function checkLogin() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        alert("„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
    }

    // ‚úç ÊäïÁ®øÂá¶ÁêÜ
    document.getElementById("postForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const content = document.getElementById("content").value;
      const file = document.getElementById("image").files[0];
      let imageUrl = null;

      if (file) {
        const { data, error } = await supabase.storage.from("images").upload(`${Date.now()}_${file.name}`, file);
        if (!error) {
          const { data: urlData } = supabase.storage.from("images").getPublicUrl(data.path);
          imageUrl = urlData.publicUrl;
        }
      }

      await supabase.from("posts").insert([{ user_id: currentUser.id, content, image_url: imageUrl }]);
      document.getElementById("content").value = "";
      document.getElementById("image").value = "";
      loadPosts();
    });

    // ‚ù§Ô∏è „ÅÑ„ÅÑ„Å≠Âá¶ÁêÜ + ÈÄöÁü•
    async function likePost(postId, postUserId) {
      const { error } = await supabase.from("likes").insert([{ user_id: currentUser.id, post_id: postId }]);
      if (!error) {
        await supabase.from("notifications").insert([{
          user_id: postUserId,
          from_user_id: currentUser.id,
          type: "like",
          post_id: postId
        }]);
        loadPosts();
      }
    }

    // üí¨ „Ç≥„É°„É≥„ÉàÂá¶ÁêÜ + ÈÄöÁü•
    async function addComment(postId, postUserId, content) {
      const { error } = await supabase.from("comments").insert([{ user_id: currentUser.id, post_id: postId, content }]);
      if (!error) {
        await supabase.from("notifications").insert([{
          user_id: postUserId,
          from_user_id: currentUser.id,
          type: "comment",
          post_id: postId
        }]);
        loadPosts();
      }
    }

    // üì• ÊäïÁ®ø‰∏ÄË¶ß
    async function loadPosts() {
      const { data: posts, error } = await supabase
        .from("posts")
        .select(`
          id, content, image_url, created_at,
          user: user_id (username, avatar_url, id),
          likes (user_id),
          comments (id, content, user: user_id (username))
        `)
        .order("created_at", { ascending: false });

      const box = document.getElementById("posts");
      if (error) {
        box.innerHTML = "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü";
        return;
      }

      box.innerHTML = "";
      posts.forEach(p => {
        const liked = p.likes.some(l => l.user_id === currentUser.id);
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
          <div>
            <img class="avatar" src="${p.user.avatar_url || "https://placehold.jp/30x30.png"}">
            <b>${p.user.username || "ÂêçÁÑ°„Åó"}</b>
            <small style="color:gray;">${new Date(p.created_at).toLocaleString()}</small>
          </div>
          <p>${p.content}</p>
          ${p.image_url ? `<img src="${p.image_url}" class="post-img">` : ""}
          <div>
            <span class="like-btn">${liked ? "‚ù§Ô∏è„ÅÑ„ÅÑ„Å≠Ê∏à„Åø" : "‚ô°„ÅÑ„ÅÑ„Å≠"}</span>(${p.likes.length})
            <span class="comment-btn">üí¨„Ç≥„É°„É≥„Éà</span>(${p.comments.length})
          </div>
          <div class="comments">
            ${p.comments.map(c => `<div class="comment"><b>${c.user.username}:</b> ${c.content}</div>`).join("")}
            <input type="text" placeholder="„Ç≥„É°„É≥„Éà„ÇíÊõ∏„Åè" class="comment-input">
            <button class="comment-submit">ÈÄÅ‰ø°</button>
          </div>
        `;

        // „ÅÑ„ÅÑ„Å≠„Éú„Çø„É≥
        div.querySelector(".like-btn").onclick = () => likePost(p.id, p.user.id);
        // „Ç≥„É°„É≥„ÉàÈÄÅ‰ø°
        div.querySelector(".comment-submit").onclick = () => {
          const input = div.querySelector(".comment-input");
          if (input.value.trim() !== "") {
            addComment(p.id, p.user.id, input.value.trim());
          }
        };

        box.appendChild(div);
      });
    }

    checkLogin().then(loadPosts);
  </script>
</body>
</html>
