<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>VTube - „Çø„Ç§„É†„É©„Ç§„É≥</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; }
    .post { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 10px; }
    textarea { width: 100%; padding: 8px; }
    img.post-image { max-width: 100%; border-radius: 10px; margin-top: 5px; }
  </style>
</head>
<body>
  <h1>üì¢ VTube „Çø„Ç§„É†„É©„Ç§„É≥</h1>

  <!-- ÊäïÁ®ø„Éï„Ç©„Éº„É† -->
  <textarea id="postContent" placeholder="„ÅÑ„Åæ„Å©„ÅÜ„Åó„Å¶„ÇãÔºü"></textarea><br>
  <input type="file" id="postImage" accept="image/*"><br>
  <button id="postButton">ÊäïÁ®ø</button>

  <h2>„Çø„Ç§„É†„É©„Ç§„É≥</h2>
  <div id="timeline"></div>

  <script>
    // Supabase ÂàùÊúüÂåñ
    const supabaseUrl = "https://yvxynwjfngvqwjjsqdma.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2eHlud2pmbmd2cXdqanNxZG1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MTExMjQsImV4cCI6MjA3MTA4NzEyNH0.RLAfsXbVLT1fTu48_EvMYYD4pxFRQk4Ks3zx8DXruBU";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let currentUser = null;

    // „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
    async function checkLogin() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        alert("„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        location.href = "index.html"; // „Éõ„Éº„É†„Å´Êàª„Åô
      } else {
        currentUser = user;
        loadPosts();
      }
    }

    // ÊäïÁ®ø„Éú„Çø„É≥Âá¶ÁêÜ
    document.getElementById("postButton").addEventListener("click", async () => {
      const content = document.getElementById("postContent").value.trim();
      const fileInput = document.getElementById("postImage");
      let imageUrl = null;

      // ÁîªÂÉè„ÅåÈÅ∏„Å∞„Çå„Å¶„Åü„Çâ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const filePath = `${currentUser.id}/${Date.now()}-${file.name}`;

        const { error: uploadError } = await supabase.storage
          .from("post-images")
          .upload(filePath, file);

        if (uploadError) {
          alert("ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ§±Êïó: " + uploadError.message);
          return;
        }

        // ÂÖ¨ÈñãURL„ÇíÂèñÂæó
        const { data: publicUrlData } = supabase.storage
          .from("post-images")
          .getPublicUrl(filePath);

        imageUrl = publicUrlData.publicUrl;
      }

      // ÊäïÁ®ø‰øùÂ≠ò
      const { error } = await supabase.from("posts").insert({
        user_id: currentUser.id,
        content,
        image_url: imageUrl
      });

      if (!error) {
        document.getElementById("postContent").value = "";
        document.getElementById("postImage").value = "";
        loadPosts();
      }
    });

    // „Çø„Ç§„É†„É©„Ç§„É≥Ë°®Á§∫
    async function loadPosts() {
      const { data: posts } = await supabase
        .from("posts")
        .select(`
          content, created_at, image_url,
          profiles:user_id (username, avatar_url)
        `)
        .order("created_at", { ascending: false });

      const timeline = document.getElementById("timeline");
      timeline.innerHTML = "";

      posts.forEach(post => {
        const avatar = post.profiles?.avatar_url || "https://placehold.jp/50x50.png";
        const username = post.profiles?.username || "ÂêçÁÑ°„Åó";

        const div = document.createElement("div");
        div.className = "post";

        div.innerHTML = `
          <div style="display:flex; align-items:center; gap:10px;">
            <img src="${avatar}" style="width:40px; height:40px; border-radius:50%;">
            <strong>${username}</strong>
          </div>
          <p>${post.content}</p>
          ${post.image_url ? `<img src="${post.image_url}" class="post-image">` : ""}
          <small>${new Date(post.created_at).toLocaleString()}</small>
        `;
        timeline.appendChild(div);
      });
    }

    checkLogin();
  </script>
</body>
</html>
